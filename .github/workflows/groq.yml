name: Parse Groq Data with Smart API Rotation

on:
  workflow_dispatch:
    # Bisa dijalankan manual
  schedule:
    - cron: '0 * * * *' # setiap jam

jobs:
  parse_groq:
    runs-on: ubuntu-latest
    env:
      RAW_DIR: data_raw
      OUT_DIR: data_clean
      MODEL: llama-3.3-70b-versatile
      GROQ_API_KEYS: ${{ secrets.GROQ_API_KEY1 }},${{ secrets.GROQ_API_KEY2 }},${{ secrets.GROQ_API_KEY3 }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests groq beautifulsoup4

      - name: Run Groq Parser with Smart API Rotation
        run: |
          echo "ðŸš€ Menjalankan parser_groq.py dengan smart API rotation..."
          
          IFS=',' read -r -a API_KEYS <<< "$GROQ_API_KEYS"
          MAX_RETRY=3
          COUNT=0
          SUCCESS=0

          while [ $COUNT -lt $MAX_RETRY ] && [ $SUCCESS -eq 0 ]; do
            for KEY in "${API_KEYS[@]}"; do
              echo "ðŸ§  Mencoba dengan API key: $KEY"
              export GROQ_API_KEY=$KEY
              python parser_groq.py
              STATUS=$?
              if [ $STATUS -eq 0 ]; then
                SUCCESS=1
                break
              else
                echo "âš ï¸ Parser gagal dengan API key ini, coba API key berikutnya..."
                sleep 10
              fi
            done
            COUNT=$((COUNT+1))
            if [ $SUCCESS -eq 0 ]; then
              echo "âš ï¸ Semua API key gagal, menunggu 60 detik sebelum retry ($COUNT/$MAX_RETRY)..."
              sleep 60
            fi
          done

      - name: Commit & Push JSON
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data_clean/*.json || echo "Tidak ada file untuk commit"
          git commit -m "ðŸ¤– Update hasil parsing Groq" || echo "Tidak ada perubahan"
          git push origin main || echo "Push gagal"